Ajax.Responders.register({onCreate:function(d){d=d.transport;d.setRequestHeader=d.setRequestHeader.wrap(function(c,a,d){if(/^(accept|accept-language|content-language)$/i.test(a)||/^content-type$/i.test(a)&&/^(application\/x-www-form-urlencoded|multipart\/form-data|text\/plain)(;.+)?$/i.test(d))return c(a,d)})}});
var GW2Maps={init:function(d){if("object"!==typeof d)return!1;var c=GW2Maps.options(d),a={map:L.map(d,{minZoom:0,maxZoom:c.max_zoom,crs:L.CRS.Simple,zoomControl:c.map_controls,attributionControl:c.map_controls}),layers:{},linkbox:(new Element("div",{"class":"linkbox"})).setStyle({width:c.linkbox,height:c.height}),continent:c.continent_id};if(c.linkbox){var e=(new Element("div",{"class":"table-cell"})).setStyle({width:"100%"});d.setStyle({width:"100%",height:c.height}).wrap(e).wrap((new Element("div",
{"class":"table-row"})).setStyle({width:c.width}));e.insert({after:a.linkbox.wrap(new Element("div",{"class":"table-cell"}))})}else d.setStyle({width:c.width,height:c.height});L.tileLayer("https://tiles.guildwars2.com/{continent_id}/{floor_id}/{z}/{x}/{y}.jpg",{errorTileUrl:c.i18n.errortile,minZoom:0,maxZoom:c.max_zoom,continuousWorld:!0,continent_id:c.continent_id,floor_id:c.floor_id,attribution:c.i18n.attribution+': <a href="https://forum-en.guildwars2.com/forum/community/api/API-Documentation" target="_blank">GW2 Maps API</a>, &copy;<a href="http://www.arena.net/" target="_blank">ArenaNet</a>'}).addTo(a.map);
a.layers[c.i18n.event]=L.layerGroup();a.layers[c.i18n.landmark]=L.layerGroup();a.layers[c.i18n.polyline]=L.layerGroup();a.layers[c.i18n.players]=L.layerGroup();a.layers[c.i18n.players].addTo(a.map);a.layers[c.i18n.skill]=L.layerGroup();a.layers[c.i18n.task]=L.layerGroup();a.layers[c.i18n.vista]=L.layerGroup();a.layers[c.i18n.waypoint]=L.layerGroup();a.layers[c.i18n.waypoint].addTo(a.map);a.layers[c.i18n.sector]=L.layerGroup();3<a.map.getZoom()&&(a.layers[c.i18n.landmark].addTo(a.map),a.layers[c.i18n.skill].addTo(a.map),
a.layers[c.i18n.task].addTo(a.map),a.layers[c.i18n.vista].addTo(a.map));4<a.map.getZoom()&&a.layers[c.i18n.polyline].addTo(a.map);if(c.region_id&&c.map_id||5<a.map.getZoom())a.layers[c.i18n.sector].addTo(a.map),a.layers[c.i18n.event].addTo(a.map);c.map_controls&&L.control.layers(null,a.layers).addTo(a.map);c.polyline&&7<c.polyline.length&&GW2Maps.parse_polylines(a,c);a.map.on("zoomend",function(){var d=a.map.getZoom();5<d?a.layers[c.i18n.event].addTo(a.map):a.map.removeLayer(a.layers[c.i18n.event]);
5<d?a.layers[c.i18n.sector].addTo(a.map):a.map.removeLayer(a.layers[c.i18n.sector]);4<d?a.layers[c.i18n.polyline].addTo(a.map):a.map.removeLayer(a.layers[c.i18n.polyline]);3<d?a.layers[c.i18n.landmark].addTo(a.map):a.map.removeLayer(a.layers[c.i18n.landmark]);3<d?a.layers[c.i18n.skill].addTo(a.map):a.map.removeLayer(a.layers[c.i18n.skill]);3<d?a.layers[c.i18n.task].addTo(a.map):a.map.removeLayer(a.layers[c.i18n.task]);3<d?a.layers[c.i18n.vista].addTo(a.map):a.map.removeLayer(a.layers[c.i18n.vista])});
a.map.on("click",function(d){console.log(a.map.project(d.latlng,c.max_zoom).toString())});new Ajax.Request("https://api.guildwars2.com/v1/map_floor.json?continent_id="+c.continent_id+"&floor="+c.floor_id+"&lang="+c.i18n.lang,{method:"get",onSuccess:function(d){new Ajax.Request("https://api.guildwars2.com/v1/event_details.json?lang="+c.i18n.lang,{method:"get",onSuccess:function(e){var l={};$H(e.responseJSON.events).each(function(c){"undefined"===typeof l[c[1].map_id]&&(l[c[1].map_id]={});l[c[1].map_id][c[0]]=
c[1]});GW2Maps.parse_response(a,c,d.responseJSON,l)},onFailure:function(c){console.log(c)}})},onFailure:function(d){console.log(d);c.region_id=!1;GW2Maps.parse_response(a,c,{texture_dims:1===c.continent_id?[32768,32768]:[16384,16384],regions:[]},{})}});return a},parse_response:function(d,c,a,e){var f,k=function(a){return d.map.unproject(a,c.max_zoom)};a.clamped_view?(f=a.clamped_view,f=(new L.LatLngBounds(k([f[0][0],f[1][1]]),k([f[1][0],f[0][1]]))).pad(0.2)):c.region_id&&c.map_id?(f=a.regions[c.region_id].maps[c.map_id].continent_rect,
f=(new L.LatLngBounds(k([f[0][0],f[1][1]]),k([f[1][0],f[0][1]]))).pad(0.4)):f=(new L.LatLngBounds(k([0,a.texture_dims[1]]),k([a.texture_dims[0],0]))).pad(0.1);d.map.setMaxBounds(f).fitBounds(f);c.region_id&&c.map_id?(f="undefined"!==typeof e[c.map_id]?e[c.map_id]:!1,GW2Maps.parse_map(d,c,a.regions[c.region_id].maps[c.map_id],f)):$H(a.regions).each(function(a){$H(a[1].maps).each(function(a){GW2Maps.parse_map(d,c,a[1],"undefined"!==typeof e[a[0]]?e[a[0]]:!1)})})},parse_map:function(d,c,a,e){var f={task:[],
event:[],landmark:[],skill:[],vista:[],waypoint:[],sector:[]},k={task:[],event:[],landmark:[],skill:[],vista:[],waypoint:[],sector:[]};a.points_of_interest.each(function(a){"waypoint"==a.type&&(k.waypoint.push(a.name),f.waypoint.push({id:a.poi_id,type:a.type,coords:a.coord,title:a.name,text:a.name,popup:a.name+"<br />id:"+a.poi_id+"<br />"+a.coord.toString()}));"landmark"==a.type&&(k.landmark.push(a.name),f.landmark.push({id:a.poi_id,type:a.type,coords:a.coord,title:a.name,text:a.name,popup:'<a href="'+
c.i18n.wiki+encodeURIComponent(a.name)+'" target="_blank">'+a.name+"</a><br />id:"+a.poi_id}));"vista"==a.type&&(k.vista.push(a.poi_id),f.vista.push({type:a.type,coords:a.coord,title:"id:"+a.poi_id,text:a.name+" "+a.poi_id,popup:"id:"+a.poi_id}))});a.tasks.each(function(a){k.task.push(a.level);f.task.push({id:a.task_id,type:"task",coords:a.coord,title:a.objective+" ("+a.level+")",text:"("+a.level+") "+a.objective,popup:'<a href="'+c.i18n.wiki+encodeURIComponent(a.objective.replace(/\.$/,""))+'" target="_blank">'+
a.objective+"</a> ("+a.level+")<br />id:"+a.task_id})});a.skill_challenges.each(function(a){k.skill.push(a.coord.toString());f.skill.push({id:null,type:"skill",coords:a.coord,title:a.coord.toString(),text:a.name+" "+a.coord.toString(),popup:a.name+" "+a.coord.toString()})});a.sectors.each(function(a){k.sector.push(a.name);f.sector.push({id:a.sector_id,type:"sector",coords:a.coord,title:a.name+", id:"+a.sector_id,icon_text:a.name,icon_text_class:"sector_text",text:a.name,popup:!1})});e&&$H(e).each(function(d){k.event.push(d[1].level);
f.event.push({id:d[0],type:"event",coords:[Math.round(a.continent_rect[0][0]+(a.continent_rect[1][0]-a.continent_rect[0][0])*(d[1].location.center[0]-a.map_rect[0][0])/(a.map_rect[1][0]-a.map_rect[0][0])),Math.round(a.continent_rect[0][1]+(a.continent_rect[1][1]-a.continent_rect[0][1])*(1-(d[1].location.center[1]-a.map_rect[0][1])/(a.map_rect[1][1]-a.map_rect[0][1])))],title:d[1].name+" ("+d[1].level+")",text:"("+d[1].level+") "+d[1].name,popup:'<a href="'+c.i18n.wiki+encodeURIComponent(d[1].name.replace(/\.$/,
""))+'" target="_blank">'+d[1].name+"</a> ("+d[1].level+")<br />id:"+d[0]})});d.linkbox.insert((new Element("div",{"class":"header"})).update(a.name));$H(f).each(function(a){0<a[1].length&&(phpjs.array_multisort(k[a[0]],"SORT_ASC",a[1]),d.linkbox.insert((new Element("div",{"class":"header sub"})).update(c.i18n[a[0]])),a[1].each(function(a){GW2Maps.parse_point(d,c,a)}))})},parse_point:function(d,c,a){var e=c.i18n["icon_"+a.type],f,k=function(a,e){var f=d.map.unproject(a,c.max_zoom);d.map.panTo(f);
e&&L.popup({offset:new L.Point(0,-5)}).setLatLng(f).setContent(e).openOn(d.map)};f="sector"===a.type?L.divIcon({className:a.icon_text_class,html:a.icon_text}):L.icon({iconUrl:e.link,iconSize:e.size,popupAnchor:[0,-e.size[1]/2]});f=L.marker(d.map.unproject(a.coords,c.max_zoom),{title:a.title,icon:f});a.popup&&f.bindPopup(a.popup);d.layers[c.i18n[a.type]].addLayer(f);d.linkbox.insert((new Element("div")).insert(e?(new Element("img",{src:e.link})).setStyle({width:"16px",height:"16px"}):"").insert(" "+
a.text).observe("click",function(){k(a.coords,a.popup)}));c.poi_id&&(a.id===c.poi_id&&c.poi_type&&a.type===c.poi_type)&&(k(a.coords,a.popup),d.map.setZoom(c.max_zoom))},parse_polylines:function(d,c){c.polyline.split(";").each(function(a){var e=[],f={};a.split(" ").each(function(a){if(a.match(/\d{1,5},\d{1,5}/)){var g=a.split(",");e.push(d.map.unproject(g,c.max_zoom))}a.match(/(color|width|opacity|style|type)=(([0-9a-f]{3}){1,2}|\d{1,3}|(arrow|marker|dash))/i)&&(a=a.toLowerCase().split("="),f[a[0]]=
a[1])});a="undefined"!==typeof f.color?"#"+f.color:"#ffe500";var k="undefined"!==typeof f.width?phpjs.intval(f.width):3,l="undefined"!==typeof f.opacity?phpjs.intval(f.opacity)/100:0.8,e=L.polyline(e,{color:a,weight:k,opacity:l,dashArray:"dash"===f.style?"30,15,10,15":""});d.layers[c.i18n.polyline].addLayer(e);if("undefined"!==typeof f.type){var g=[];"arrow"===f.type&&g.push({offset:50,repeat:"150px",symbol:new L.Symbol.ArrowHead({pixelSize:15,polygon:!1,pathOptions:{stroke:!0,color:a,weight:k,opacity:l}})});
"marker"===f.type&&g.push({offset:0,repeat:"100%",symbol:new L.Symbol.Marker});d.layers[c.i18n.polyline].addLayer(L.polylineDecorator(e,{patterns:g}))}})},options:function(d){var c={};$A(d.attributes).each(function(a){a.name.match(/^data-/)&&(c[a.name.substr(5)]="data-polyline"===a.name?a.value:phpjs.intval(a.value))});d=["en","de","en","es","fr"];var a=[!1,"landmark","sector","skill","task","vista","waypoint"],e="number"===typeof c.continent_id&&1<=c.continent_id&&2>=c.continent_id?c.continent_id:
1;return{max_zoom:1==e?7:6,continent_id:e,floor_id:"number"===typeof c.floor_id?c.floor_id:2,region_id:"number"===typeof c.region_id&&0<c.region_id?c.region_id:!1,map_id:"number"===typeof c.map_id&&0<c.map_id?c.map_id:!1,poi_id:"number"===typeof c.poi_id&&0<c.poi_id?c.poi_id:!1,poi_type:"number"===typeof c.poi_type&&0<c.poi_type&&6>=c.poi_type?a[c.poi_type]:!1,width:"number"===typeof c.width&&0<c.width?c.width+(!0==c.w_percent?"%":"px"):"800px",height:"number"===typeof c.height&&0<c.height?c.height+
(!0==c.h_percent?"%":"px"):"450px",map_controls:!0!=c.disable_controls,linkbox:"number"===typeof c.linkbox&&100<=c.linkbox?c.linkbox+"px":!1,polyline:c.polyline&&7<c.polyline.length?c.polyline:!1,i18n:"number"===typeof c.language&&1<=c.language&&4>=c.language?GW2Maps.i18n[d[c.language]]:GW2Maps.i18n[d[0]]}},i18n:{de:{lang:"de",wiki:"http://wiki-de.guildwars2.com/wiki/",icon_event:{link:"http://wiki-de.guildwars2.com/images/7/7a/Event_Angriff_Icon.png",size:[24,24]},icon_landmark:{link:"http://wiki-de.guildwars2.com/images/0/0f/Sehensw\u00fcrdigkeit_Icon.png",
size:[16,16]},icon_skill:{link:"http://wiki-de.guildwars2.com/images/c/c3/Fertigkeitspunkt_Icon.png",size:[20,20]},icon_task:{link:"http://wiki-de.guildwars2.com/images/b/b7/Aufgabe_Icon.png",size:[20,20]},icon_vista:{link:"http://wiki-de.guildwars2.com/images/9/9f/Aussichtspunkt_Icon.png",size:[20,20]},icon_waypoint:{link:"http://wiki-de.guildwars2.com/images/d/df/Wegmarke_Icon.png",size:[24,24]},errortile:"http://wiki-de.guildwars2.com/images/6/6f/Kartenhintergrund.png",event:"Events",landmark:"Sehensw\u00fcrdigkeiten",
players:"Spieler",polyline:"Polylinien",sector:"Zonen",skill:"Fertigkeitspunkte",task:"Aufgaben",vista:"Aussichtspunkte",waypoint:"Wegpunkte",attribution:"Kartendaten und -bilder"},en:{lang:"en",wiki:"http://wiki.guildwars2.com/wiki/",icon_event:{link:"http://wiki-de.guildwars2.com/images/7/7a/Event_Angriff_Icon.png",size:[24,24]},icon_landmark:{link:"http://wiki.guildwars2.com/images/f/fb/Point_of_interest.png",size:[20,20]},icon_skill:{link:"http://wiki.guildwars2.com/images/8/84/Skill_point.png",
size:[20,20]},icon_task:{link:"http://wiki.guildwars2.com/images/f/f8/Complete_heart_(map_icon).png",size:[20,20]},icon_vista:{link:"http://wiki.guildwars2.com/images/d/d9/Vista.png",size:[20,20]},icon_waypoint:{link:"http://wiki.guildwars2.com/images/d/d2/Waypoint_(map_icon).png",size:[20,20]},errortile:"http://wiki-de.guildwars2.com/images/6/6f/Kartenhintergrund.png",event:"Events",landmark:"Points of Interest",players:"Players",polyline:"Polylines",sector:"Sector Names",skill:"Skill Challenges",
task:"Tasks",vista:"Vistas",waypoint:"Waypoints",attribution:"Map data and imagery"},es:{lang:"es",wiki:"http://wiki-es.guildwars2.com/wiki/",icon_event:{link:"http://wiki-de.guildwars2.com/images/7/7a/Event_Angriff_Icon.png",size:[24,24]},icon_landmark:{link:"http://wiki.guildwars2.com/images/f/fb/Point_of_interest.png",size:[20,20]},icon_skill:{link:"http://wiki.guildwars2.com/images/8/84/Skill_point.png",size:[20,20]},icon_task:{link:"http://wiki.guildwars2.com/images/f/f8/Complete_heart_(map_icon).png",
size:[20,20]},icon_vista:{link:"http://wiki.guildwars2.com/images/d/d9/Vista.png",size:[20,20]},icon_waypoint:{link:"http://wiki.guildwars2.com/images/d/d2/Waypoint_(map_icon).png",size:[20,20]},errortile:"http://wiki-de.guildwars2.com/images/6/6f/Kartenhintergrund.png",event:"event-es",landmark:"poi-es",players:"players-es",polyline:"polyline-es",sector:"sector-es",skill:"skill-es",task:"task-es",vista:"vista-es",waypoint:"waypoint-es",attribution:"attribution-es"},fr:{lang:"fr",wiki:"http://wiki-fr.guildwars2.com/wiki/",
icon_event:{link:"http://wiki-de.guildwars2.com/images/7/7a/Event_Angriff_Icon.png",size:[24,24]},icon_landmark:{link:"http://wiki-fr.guildwars2.com/images/d/d2/Ic\u00f4ne_site_remarquable_d\u00e9couvert.png",size:[20,20]},icon_skill:{link:"http://wiki-fr.guildwars2.com/images/5/5c/Progression_d\u00e9fi.png",size:[20,20]},icon_task:{link:"http://wiki-fr.guildwars2.com/images/a/af/Ic\u00f4ne_coeur_plein.png",size:[20,20]},icon_vista:{link:"http://wiki-fr.guildwars2.com/images/8/82/Ic\u00f4ne_panorama.png",
size:[20,20]},icon_waypoint:{link:"http://wiki-fr.guildwars2.com/images/5/56/Progression_passage.png",size:[20,20]},errortile:"http://wiki-de.guildwars2.com/images/6/6f/Kartenhintergrund.png",event:"event-fr",landmark:"Sites remarquables",players:"players-fr",polyline:"polyline-fr",sector:"Secteurs",skill:"D\u00e9fis de comp\u00e9tences",task:"C\u0153urs",vista:"Panoramas",waypoint:"Points de passage",attribution:"attribution-fr"}}},phpjs={intval:function(d,c){var a;a=typeof d;return"boolean"===a?
+d:"string"===a?(a=parseInt(d,c||10),isNaN(a)||!isFinite(a)?0:a):"number"===a&&isFinite(d)?d|0:0},array_multisort:function(d){var c={SORT_REGULAR:16,SORT_NUMERIC:17,SORT_STRING:18,SORT_ASC:32,SORT_DESC:40},a=0,e=[[]],f=[[]],k=[0],l=0,g=0,h,t="",a=0,u=[],p=0,a=null,s=[],r=[],p=[],n=[],q=0,v=function(){return s.shift()},w=[[function(a,c){r.push(a>c?1:a<c?-1:0);return a>c?1:a<c?-1:0},function(a,c){r.push(c>a?1:c<a?-1:0);return c>a?1:c<a?-1:0}],[function(a,c){r.push(a-c);return a-c},function(a,c){r.push(c-
a);return c-a}],[function(a,c){r.push(a+"">c+""?1:a+""<c+""?-1:0);return a+"">c+""?1:a+""<c+""?-1:0},function(a,c){r.push(c+"">a+""?1:c+""<a+""?-1:0);return c+"">a+""?1:c+""<a+""?-1:0}]];if("[object Array]"===Object.prototype.toString.call(d))e[0]=d;else if(d&&"object"===typeof d)for(g in d)d.hasOwnProperty(g)&&(f[0].push(g),e[0].push(d[g]));else return!1;var a=e[0].length,m=[0,a];for(h=1;h<arguments.length;h++)if("[object Array]"===Object.prototype.toString.call(arguments[h])){if(e[h]=arguments[h],
k[h]=0,arguments[h].length!==a)return!1}else if(arguments[h]&&"object"===typeof arguments[h]){f[h]=[];e[h]=[];k[h]=0;for(g in arguments[h])arguments[h].hasOwnProperty(g)&&(f[h].push(g),e[h].push(arguments[h][g]));if(e[h].length!==a)return!1}else if("string"===typeof arguments[h]){p=k.pop();if("undefined"===typeof c[arguments[h]]||0<(c[arguments[h]]>>>4&p>>>4))return!1;k.push(p+c[arguments[h]])}else return!1;for(g=0;g!==a;g++)u.push(!0);for(g in e)if(e.hasOwnProperty(g)){p=[];n=[];q=0;s=[];r=[];if(0===
m.length)if("[object Array]"===Object.prototype.toString.call(arguments[g]))arguments[g]=e[g];else{for(t in arguments[g])arguments[g].hasOwnProperty(t)&&delete arguments[g][t];a=e[g].length;for(p=h=0;h<a;h++)p=f[g][h],arguments[g][p]=e[g][h]}else{c=w[k[g]&3][0<(k[g]&8)?1:0];for(a=0;a!==m.length;a+=2)for(l in n=e[g].slice(m[a],m[a+1]+1),n.sort(c),p[a]=[].concat(r),q=m[a],n)n.hasOwnProperty(l)&&(e[g][q]=n[l],q++);c=v;for(h in e)if(e.hasOwnProperty(h)&&e[h]!==e[g])for(a=0;a!==m.length;a+=2)for(l in n=
e[h].slice(m[a],m[a+1]+1),s=[].concat(p[a]),n.sort(c),q=m[a],n)n.hasOwnProperty(l)&&(e[h][q]=n[l],q++);for(h in f)if(f.hasOwnProperty(h))for(a=0;a!==m.length;a+=2)for(l in n=f[h].slice(m[a],m[a+1]+1),s=[].concat(p[a]),n.sort(c),q=m[a],n)n.hasOwnProperty(l)&&(f[h][q]=n[l],q++);a=null;m=[];for(h in e[g])e[g].hasOwnProperty(h)&&(u[h]?m.length&1?e[g][h]!==a&&(m.push(h-1),a=e[g][h]):(null!==a&&(e[g][h]===a?m.push(h-1):u[h]=!1),a=e[g][h]):(m.length&1&&m.push(h-1),a=null));m.length&1&&m.push(h);if("[object Array]"===
Object.prototype.toString.call(arguments[g]))arguments[g]=e[g];else{for(h in arguments[g])arguments[g].hasOwnProperty(h)&&delete arguments[g][h];a=e[g].length;for(p=h=0;h<a;h++)p=f[g][h],arguments[g][p]=e[g][h]}}delete e[g];delete f[g]}return!0}};
L.GeometryUtil={computeAngle:function(d,c){return 180*Math.atan2(c.y-d.y,c.x-d.x)/Math.PI+90},getPointPathPixelLength:function(d){if(2>d.length)return 0;for(var c=0,a=d[0],e=1,f=d.length;e<f;e++)c+=a.distanceTo(a=d[e]);return c},getPixelLength:function(d,c){var a=d instanceof L.Polyline?d.getLatLngs():d;if(2>a.length)return 0;for(var e=0,f=c.latLngToLayerPoint(a[0]),k=1,l=a.length;k<l;k++)e+=f.distanceTo(f=c.latLngToLayerPoint(a[k]));return e},projectPatternOnPath:function(d,c,a,e){for(var f=[],k=
0,l=d.length;k<l;k++)f[k]=e.latLngToLayerPoint(d[k]);d=this.projectPatternOnPointPath(f,c,a);k=0;for(l=d.length;k<l;k++)d[k].latLng=e.layerPointToLatLng(d[k].pt);return d},projectPatternOnPointPath:function(d,c,a){var e=[],f=L.GeometryUtil.getPointPathPixelLength(d)*a;c=L.GeometryUtil.interpolateOnPointPath(d,c);e.push(c);if(0<a)for(d=d.slice(c.predecessor),d[0]=c.pt,a=L.GeometryUtil.getPointPathPixelLength(d);f<=a;)c=L.GeometryUtil.interpolateOnPointPath(d,f/a),e.push(c),d=d.slice(c.predecessor),
d[0]=c.pt,a=L.GeometryUtil.getPointPathPixelLength(d);return e},interpolateOnPointPath:function(d,c){var a=d.length;if(2>a)return null;if(0>=c)return{pt:d[0],predecessor:0,heading:L.GeometryUtil.computeAngle(d[0],d[1])};if(1<=c)return{pt:d[a-1],predecessor:a-1,heading:L.GeometryUtil.computeAngle(d[a-2],d[a-1])};if(2==a)return{pt:L.GeometryUtil.interpolateBetweenPoints(d[0],d[1],c),predecessor:0,heading:L.GeometryUtil.computeAngle(d[0],d[1])};for(var e=L.GeometryUtil.getPointPathPixelLength(d),f=b=
d[0],k=ratioB=0,l=0,g=1;g<a&&ratioB<c;g++)f=b,k=ratioB,b=d[g],l+=f.distanceTo(b),ratioB=l/e;return{pt:L.GeometryUtil.interpolateBetweenPoints(f,b,(c-k)/(ratioB-k)),predecessor:g-2,heading:L.GeometryUtil.computeAngle(f,b)}},interpolateBetweenPoints:function(d,c,a){return c.x!=d.x?new L.Point(d.x*(1-a)+a*c.x,d.y*(1-a)+a*c.y):new L.Point(d.x,d.y+(c.y-d.y)*a)}};
L.RotatedMarker=L.Marker.extend({options:{angle:0},_setPos:function(d){L.Marker.prototype._setPos.call(this,d);if(!L.Browser.ie||L.Browser.ie3d)d=" rotate("+this.options.angle+"deg)",this._icon.style.MozTransform+=d,this._icon.style.MsTransform+=d,this._icon.style.OTransform+=d,this._icon.style.WebkitTransform+=d;else{var c=this.options.angle*L.LatLng.DEG_TO_RAD;d=Math.cos(c);c=Math.sin(c);this._icon.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+d+", M12="+
-c+", M21="+c+", M22="+d+")"}}});L.Symbol=L.Symbol||{};
L.Symbol.Dash=L.Class.extend({isZoomDependant:!0,options:{pixelSize:10,pathOptions:{}},initialize:function(d){L.Util.setOptions(this,d);this.options.pathOptions.clickable=!1},buildSymbol:function(d,c,a){c=this.options;if(1>=c.pixelSize)return new L.Polyline([d.latLng,d.latLng],c.pathOptions);var e=a.project(d.latLng);d=-(d.heading-90)*L.LatLng.DEG_TO_RAD;d=new L.Point(e.x+c.pixelSize*Math.cos(d+Math.PI)/2,e.y+c.pixelSize*Math.sin(d)/2);e=e.add(e.subtract(d));return new L.Polyline([a.unproject(d),
a.unproject(e)],c.pathOptions)}});
L.Symbol.ArrowHead=L.Class.extend({isZoomDependant:!0,options:{polygon:!0,pixelSize:10,headAngle:60,pathOptions:{stroke:!1,weight:2}},initialize:function(d){L.Util.setOptions(this,d);this.options.pathOptions.clickable=!1},buildSymbol:function(d,c,a){c=this.options;return c.polygon?new L.Polygon(this._buildArrowPath(d,a),c.pathOptions):new L.Polyline(this._buildArrowPath(d,a),c.pathOptions)},_buildArrowPath:function(d,c){var a=c.project(d.latLng),e=-(d.heading-90)*L.LatLng.DEG_TO_RAD,f=this.options.headAngle/
2*L.LatLng.DEG_TO_RAD,k=e+f,e=e-f,k=new L.Point(a.x-this.options.pixelSize*Math.cos(k),a.y+this.options.pixelSize*Math.sin(k)),a=new L.Point(a.x-this.options.pixelSize*Math.cos(e),a.y+this.options.pixelSize*Math.sin(e));return[c.unproject(k),d.latLng,c.unproject(a)]}});
L.Symbol.Marker=L.Class.extend({isZoomDependant:!1,options:{markerOptions:{},rotate:!1},initialize:function(d){L.Util.setOptions(this,d);this.options.markerOptions.clickable=!1;this.options.markerOptions.draggable=!1},buildSymbol:function(d){return this.options.rotate?(this.options.markerOptions.angle=d.heading,new L.RotatedMarker(d.latLng,this.options.markerOptions)):new L.Marker(d.latLng,this.options.markerOptions)}});
L.PolylineDecorator=L.LayerGroup.extend({options:{patterns:[]},initialize:function(d,c){L.LayerGroup.prototype.initialize.call(this);L.Util.setOptions(this,c);this._polyline=d;this._directionPointCache=[];this._initPatterns()},_initPatterns:function(){this._directionPointCache=[];this._isZoomDependant=!1;this._patterns=[];for(var d,c=0;c<this.options.patterns.length;c++)d=this._parsePatternDef(this.options.patterns[c]),this._patterns.push(d),this._isZoomDependant=this._isZoomDependant||d.isOffsetInPixels||
d.isRepeatInPixels||d.symbolFactory.isZoomDependant},setPatterns:function(d){this.options.patterns=d;this._initPatterns();this._softRedraw()},_parsePatternDef:function(d){var c={cache:[],symbolFactory:d.symbol,isOffsetInPixels:!1,isRepeatInPixels:!1};"string"===typeof d.offset&&-1!=d.offset.indexOf("%")?c.offset=parseFloat(d.offset)/100:(c.offset=parseFloat(d.offset),c.isOffsetInPixels=0<c.offset);"string"===typeof d.repeat&&-1!=d.repeat.indexOf("%")?c.repeat=parseFloat(d.repeat)/100:(c.repeat=parseFloat(d.repeat),
c.isRepeatInPixels=0<c.repeat);return c},onAdd:function(d){this._map=d;this._draw();if(this._isZoomDependant)this._map.on("zoomend",this._softRedraw,this)},onRemove:function(d){this._map.off("zoomend",this._softRedraw,this);L.LayerGroup.prototype.onRemove.call(this,d)},_buildSymbols:function(d,c){for(var a=[],e=0,f=c.length;e<f;e++)a.push(d.buildSymbol(c[e],this._latLngs,this._map,e,f));return a},_getDirectionPoints:function(d){var c=d.cache[this._map.getZoom()];if("undefined"!=typeof c)return c;
this._latLngs=this._polyline instanceof L.Polyline?this._polyline.getLatLngs():this._polyline;if(2>this._latLngs.length)return[];var a;a=null;d.isOffsetInPixels?(a=L.GeometryUtil.getPixelLength(this._latLngs,this._map),c=d.offset/a):c=d.offset;d.isRepeatInPixels?(a=null!=a?a:L.GeometryUtil.getPixelLength(this._latLngs,this._map),a=d.repeat/a):a=d.repeat;c=L.GeometryUtil.projectPatternOnPath(this._latLngs,c,a,this._map);return d.cache[this._map.getZoom()]=c},redraw:function(){this._redraw(!0)},_softRedraw:function(){this._redraw(!1)},
_redraw:function(d){this.clearLayers();if(d)for(d=0;d<this._patterns.length;d++)this._patterns[d].cache=[];this._draw()},_drawPattern:function(d){var c=this._getDirectionPoints(d);d=this._buildSymbols(d.symbolFactory,c);for(c=0;c<d.length;c++)this.addLayer(d[c])},_draw:function(){for(var d=0;d<this._patterns.length;d++)this._drawPattern(this._patterns[d])}});L.polylineDecorator=function(d,c){return new L.PolylineDecorator(d,c)};
