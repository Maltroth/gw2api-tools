<!DOCTYPE html>
<html dir="ltr" lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Guild Wars 2 Maps API</title>
	<link rel="stylesheet" href="https://d1h9a8s8eodvjz.cloudfront.net/fonts/menomonia/08-02-12/menomonia.css" />
	<link rel="stylesheet" href="https://d1h9a8s8eodvjz.cloudfront.net/fonts/menomonia/08-02-12/menomonia-italic.css" />
	<link rel="stylesheet" href="/css/gw2maps.css" />
</head>
<body>
<div class="gw2map" data-width="100" data-w_percent="1" data-height="100" data-h_percent="1" data-continent_id="2" data-floor_id="3"></div>
<div id="inputs" style="position: absolute; top: 15px; left: 100px; padding: 0.5em; width: 200px; height: 40px; border-radius: 5px; background-color: rgba(255,255,255,0.5); text-align: center;">
	<input id="key" type="text" placeholder="your channel key" value="blahblub" />
</div>

<script src="https://ajax.googleapis.com/ajax/libs/prototype/1.7.1.0/prototype.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/scriptaculous/1.9.0/scriptaculous.js"></script>
<script src="https://maps.google.com/maps/api/js?sensor=false"></script>

<script src="/js/gw2maps-gmaps.js"></script>
<script>
	document.observe("dom:loaded",function(){
		$$(".gw2map").each(function(e){
			// catch the mapobjects
			var m = GW2Maps.init(e),
				max_zoom = function(){
					return m.map.getMapTypeId() === "1" ? 7 : 6
				},
				p2ll = function(point){
					return GW2Maps.fromPointToLatLng(point, max_zoom());
				};

			new PeriodicalExecuter(function() {
				new Ajax.Request("/examples/gw2location-ajax.php", {
					parameters:{json:Object.toJSON({get: "playerdata", key: $("key").value, continent: m.map.getMapTypeId()})},
					onSuccess: function(request){
						$H(request.responseJSON).each(function(p){
							if(p[0].match(/^[a-f0-9]{40}$/i)){
								if(typeof m.markers[p[0]] === "undefined"){
									m.markers[p[0]] = new google.maps.Marker({map: m.map, position: p2ll(p[1].pos)});
								}
								else{
									m.markers[p[0]].setPosition(p2ll(p[1].pos));
								}

								//listen to that marker
								google.maps.event.addListener(m.markers[p[0]], "mouseover", function(){
									m.popups.close(m.map);
									m.popups.setContent(p[1].charname+"<br />"+p[1].map+", "+p[1].world+"<br />"+p[1].time);
									m.popups.open(m.map, m.markers[p[0]]);
								});

								google.maps.event.addListener(m.markers[p[0]], "mouseout", function(){
									m.popups.close(m.map);
								});
							}
						});
					}
				});
			}, 10);
		});
	});
</script>
</body>
</html>